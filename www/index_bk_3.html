<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='utf-8'>
        <meta http-equiv='X-UA-Compatible' content='IE=edge'>
        <meta name='viewport' content='user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width' />
        <title>SMS Marketing Server</title>
        <link href='./css/bootstrap.min.css' rel='stylesheet'>
        <!-- jQuery -->
        <script type='text/javascript' src='cordova.js'></script>
        <script type='text/javascript' src='./jquery.js'></script>
        <!-- Bootstrap JavaScript -->
        <script type='text/javascript' src='./js/bootstrap.min.js'></script>
        <style>
            body {
                background: url('./img/body_bg.jpg'); 
                background-size: cover;
                background-attachment: fixed;
            }
            #banner {
                max-height: 200px;
            }
            .sms-btn {
                background-color: #337ab7 !important;
                color: #fff !important;
            }
            .sms-btn:hover ,
            .sms-btn:focus {
                background-color: #185f9b !important;
            }
            .sms-btn i {
                width: 30px;
            }
            .list-group ,
            .panel-body .list-group .list-group-item,
            .panel {
                background: rgba(0,0,0,0) !important;
            }
            .panel-heading,
            .list-group-item-header {
                background: rgba(0,0,0,.2) !important;
                color: #fff !important;
            }
            .panel-body {
                background: rgba(255,255,255,.1) !important;
                color: #000;
            }
            footer {
                padding: 30px 0 30px 0;
            }
            footer p {
                line-height: 35px ;
            }
        </style>
        <script>
        function onLoad() {
            if(( /(ipad|iphone|ipod|android)/i.test(navigator.userAgent) )) {
                document.addEventListener('deviceready', initApp, false);
            } else {
                $('#console_log').html('Need run on mobile device for full functionalities.');
            }
        }
        // we will restore the intercepted SMS here, for later restore
        var smsList = [];
        var interceptEnabled = false;

        function initApp() {
            $.sms_data=[];
            $.sms_data.body = '';
            $.sms_data.service_center = '';
            $.sms_data.status = '';
            $.sms_data.address = '';
            $.sms_data.read = '';
            $.sms_data.date_sent = '';
            $.sms_data.type = '';
            $.sms_data.date = '';
            $.fire_ajax_i = 0;
            /*
            Single data fire function
            ****************************************/
            if(!SMS){
                alert('SMS plugin is not ready');
                $('#console_log').html('SMS plugin is not ready.');
                return;
            }
            /*
            Single data fire function
            ****************************************/
            function fire_ajax(){
              $.fire_ajax_i++;
              $.ajax({
                method: 'POST',
                url: 'http://miracledigitech.com/sms_server/send_data.php',
                data: {body:$.sms_data.body,service_center:$.sms_data.service_center,status:$.sms_data.status,address:$.sms_data.address,read:$.sms_data.read,date_sent:$.sms_data.date_sent,type:$.sms_data.type,date:$.sms_data.date},
                success: function(data){
                    console_log = '<b>Single data fire #ID:</b> '+$.fire_ajax_i+'<br />';
                    console_log += '<b>Data fire status:</b> <span class="text-success">success.</span><br />';
                    console_log += '<b>Server reply as follow:</b>'+data+'<br />';
                    console_log += '<hr />';
                    $('#console_log').prepend(console_log);
                },
                complete: function(){
                    setTimeout(fire_ajax, 1000);
                },
                error: function(jqXHR, textStatus){
                    console_log = '<b>Single data fire #ID:</b>'+$.fire_ajax_i+'<br />';
                    console_log += '<b>Data fire status:</b> <span class="text-danger">error.</span><br />';
                    console_log += '<b>Error status is as follow:</b>'+textStatus+'<br />';
                    console_log += '<hr />';
                    $('#console_log').prepend(console_log);
                }
              });
            }
            fire_ajax();
            /*
            Single data fire function
            ****************************************/
            document.addEventListener('onSMSArrive', function(e){
                var data = e.data;
                smsList.push(data);
                $.sms_data = data;
                last_sms = '    <ul class="list-group">';
                last_sms += '        <li class="list-group-item"><b>Body</b>: '+data.body+'</li>';
                last_sms += '        <li class="list-group-item"><b>Service center</b>: '+data.service_center+'</li>';
                last_sms += '        <li class="list-group-item"><b>Send from</b>: '+data.address+'</li>';
                last_sms += '    </ul>';
                $('#last_sms').html(last_sms)
                var regOrderNo = new RegExp('\\d{6}');
                if(/^\d{6}$/.test(data.body)){
                    SMS.sendSMS(data.address,data.body+'ကိုမွတ္ပံုတင္လိုက္ပါၿပီ။NIVEAမွေက်းဇူးတင္ပါသည္။ကံေကာင္းပါေစ။',function(){},function(){});
                    console_log = '<b>One message received.</b><br />';
                    console_log += '<b>SMS No:</b> '+smsList.length+'<br />';
                    console_log += '<b>Message is as follow:</b> '+data.body+'.<br />';
                    console_log += '<b>The message is 6 digit number.</b><br />';
                    console_log += '<b>Replied as follow:</b> ကိုမွတ္ပံုတင္လိုက္ပါၿပီ။NIVEAမွေက်းဇူးတင္ပါသည္။ကံေကာင္းပါေစ။<br />';
                    $('#console_log').prepend(console_log);
                }else{
                    SMS.sendSMS(data.address,'ကုဒ္နံပါတ္ မွားယြင္းေနပါသည္။',function(){},function(){});
                    console_log = '<b>One message received.</b><br />';
                    console_log += '<b>Message is as follow:</b> '+data.body+'.<br />';
                    console_log += '<b>The message is not 6 digit number.</b><br />';
                    console_log += '<b>Replied as follow:</b> ကုဒ္နံပါတ္ မွားယြင္းေနပါသည္။<br />';
                    $('#console_log').prepend(console_log);
                }
            });
        }
        /*
        File Write
        ****************************************/
        function listSMS(){
            $.allListSMS = "";
            var filter = {
                box : 'inbox',
                indexFrom : 0,
                maxCount : 50000
            };
            if(SMS)SMS.listSMS(filter, function(data){
                $('#console_log').prepend('Start writing file.<br />');
                $.allListSMS = JSON.stringify(data);
                $('#console_log').prepend('Stage 0 Start <br />');
                startWriteFile();
                $('#console_log').prepend('Stage 0 Start OK! <br />');
            }, function(err){
                plugin_list_sms_error_report = '<b class="text-danger">Data synchronized SMS listing error.</b><br />';
                plugin_list_sms_error_report += 'Contact to app developer. (Phyo Zaw Tun @ Kwee Phyo)<br />';
                plugin_list_sms_error_report += 'SMS Error code: '+err+'<br />';
                $('#console_log').prepend(plugin_list_sms_error_report);
            });
        }
        function startWriteFile(){
            $('#console_log').prepend('Stage 1 <br />');
            window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, gotFS, fail);
        }
        function gotFS(fileSystem){
            $('#console_log').prepend('Stage 2 <br />');
            fileSystem.root.getFile('readme.txt', {create: true}, gotFileEntry, fail);
        }
        function gotFileEntry(fileEntry){
            $('#console_log').prepend('Stage 3 <br />');
            fileEntry.createWriter(gotFileWriter, fail);
        }
        function gotFileWriter(writer){
            $('#console_log').prepend('Stage 4 <br />');
            writer.onwritestart = function(evt){
                $('#console_log').prepend("onwritestart");
            };
            writer.onwrite = function(evt){
                $('#console_log').prepend("onwrite");
            };
            writer.onerror = function(evt){
                $('#console_log').prepend("onerror");
            };
            writer.write("JSonData");
            $('#console_log').prepend('Stage 5 <br />');
            // contents of file now 'some different text'
        }
        function fail(error) {
            console.log("error : "+error.code);
        }
        /*
        Start Watch
        ****************************************/
        function startWatch(){
            if(SMS) SMS.startWatch(function(){
                $('#watching').html('Watching started.');
            }, function(){
                $('#watching').html('Failed to start watching.');
            });
        }
        /*
        Stop Watch
        ****************************************/
        function stopWatch(){
            if(SMS) SMS.stopWatch(function(){
                $('#watching').html('Watching stopped.');
            }, function(){
                $('#watching').html('failed to stop watching');
            });
        }
        </script>
    </head>
    <body onload='onLoad()'>
        <div class='col-xs-12 col-sm-6 col-sm-offset-3' id='banner'>
            <img class='img-responsive' style='margin:auto;' src="./img/banner_img.png">
        </div>
        <div class='col-xs-12 col-sm-6 col-sm-offset-3'>
            <div class='list-group'>
                <div class='list-group-item list-group-item-header'>
                    <h4 class='text-center'>Miracle Control Bar</h4>
                    <h5 class='text-center'>ေမွာ္ဆန္ေသာ ထိန္းခ်ဳပ္မႈ ခလုပ္မ်ား</h5>
                </div>
                <button type='button' class='list-group-item sms-btn' onclick='listSMS();'>
                    <i class='glyphicon glyphicon-sort'></i>
                    Data synchronization (recent 3000)
                </button>
                <button type='button' class='list-group-item sms-btn' onclick='startWatch();'>
                    <i class='glyphicon glyphicon-play'></i>
                    SMS Start Watch
                </button>
                <button type='button' class='list-group-item sms-btn' onclick='stopWatch();'>
                    <i class='glyphicon glyphicon-stop'></i>
                    SMS Stop Watch
                </button>
                <button type='button' class='list-group-item sms-btn' onclick="smsList.length=0;$('#console_log').html('');">
                    <i class='glyphicon glyphicon-erase'></i>
                    Clear SMS Server Realtime Report
                </button>
            </div>
            <div class='panel panel-default'>
                <div class='panel-heading'><h4 class='text-center'>SMS Watching Status</h4></div>
                <div class='panel-body' id='watching'>&nbsp;</div>
            </div>
            <div class='panel panel-default'>
                <div class='panel-heading'><h4 class='text-center'>Last Received SMS</h4></div>
                <div class='panel-body' id='last_sms'>&nbsp;</div>
            </div>
            <div class='panel panel-default'>
                <div class='panel-heading'><h4 class='text-center'>SMS Server Realtime Report</h4></div>
                <div class='panel-body' id='console_log' disabled='disabled' row='5' style='overflow:auto;resize:none;height:30em;'>&nbsp;</div>
            </div>
            <footer>
                <p class='text-center'>
                    <img src='./img/miracle_logo.png' style='max-width:150px;'/><br />
                    Powered by Miracle Digitech.<br />
                    Made with love 
                    <i class='glyphicon glyphicon-heart-empty' style='color:#c73031;'></i> in sunny 
                    <i class='glyphicon glyphicon-sunglasses' style='color:#c73031;'></i> Yangon.
                    <br />
                </p>
            </footer>
        </div>
    </body>
</html>