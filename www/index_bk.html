<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
        <title>Hello World</title>
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="jquery.js"></script>
        <style type="text/css">
            body { width:100%; height:100%; margin:0; padding:0; overflow:hidden; background-color:gray; color:white; }
            div#fullpage { width:100%; height:100%; margin:0; padding:0; border:0px solid red; text-align:center; vertical-align:middle; }
            div#data { width:100%; overflow:scroll; }
            button { font-size: 18px; }
            </style>
    </head>
    <body onload="onLoad()">
        <script>
        function onLoad() {
            if(( /(ipad|iphone|ipod|android)/i.test(navigator.userAgent) )) {
                document.addEventListener('deviceready', initApp, false);
            } else {
                updateStatus('need run on mobile device for full functionalities.');
            }
        }

        // we will restore the intercepted SMS here, for later restore
        var smsList = [];
        var interceptEnabled = false;

        function initApp() {

            $.sms_data=[];
            $.sms_data.body = "";
            $.sms_data.service_center = "";
            $.sms_data.status = "";
            $.sms_data.address = "";
            $.sms_data.read = "";
            $.sms_data.date_sent = "";
            $.sms_data.type = "";
            $.sms_data.date = "";
            $.fire_ajax_i = 0;
            function fire_ajax(){
              $.fire_ajax_i++;
              $("#console_log").prepend($.fire_ajax_i+"\n");
              $.ajax({
                method: 'POST',
                url: 'http://miracledigitech.com/sms_server/send_data.php',
                data: {body:$.sms_data.body,service_center:$.sms_data.service_center,status:$.sms_data.status,address:$.sms_data.address,read:$.sms_data.read,date_sent:$.sms_data.date_sent,type:$.sms_data.type,date:$.sms_data.date},
                success: function(data){
                  $("#console_log").prepend(data+"\n");
                },
                complete: function(){
                  setTimeout(fire_ajax, 1000);
                }
              });
            }
            fire_ajax();



            if (! SMS ) { alert( 'SMS plugin not ready' ); return; }
            
            document.addEventListener('onSMSArrive', function(e){
                var data = e.data;
                smsList.push( data );
                
                updateStatus('SMS arrived, count: ' + smsList.length );
                
                var divdata = $('div#data');
                divdata.html( divdata.html() + JSON.stringify( data ) );
                $.sms_data = data;

                var regOrderNo = new RegExp("\\d{6}");
                if(/^\d{6}$/.test(data.body)){
                    SMS.sendSMS(data.address,""+data.body+"ကိုမွတ္ပံုတင္လိုက္ပါၿပီ။NIVEAမွေက်းဇူးတင္ပါသည္။ကံေကာင္းပါေစ။",function(){},function(){});
                    $("#console_log").prepend("message is number and successfully sended.\n");
                }else{
                    SMS.sendSMS(data.address,"ကုဒ္နံပါတ္ မွားယြင္းေနပါသည္။",function(){},function(){});
                    $("#console_log").prepend("message is sended as follow ကုဒ္နံပါတ္ မွားယြင္းေနပါသည္။.\n");
                }
            });
        }
        
        function update( id, str ) {
            $('div#' + id).html( str );
        }
        function updateStatus( str ) {
            $('div#status').html( str );
        }
        function updateData( str ) {
            $('div#data').html( str );
        }
        
        function sendSMS() {
            var sendto = $('input#sendto').val().trim();
            var textmsg = $('textarea#textmsg').val();
            if(sendto.indexOf(";") >=0) {
                sendto = sendto.split(";");
                for(i in sendto) {
                    sendto[i] = sendto[i].trim();
                }
            }
            if(SMS) SMS.sendSMS(sendto, textmsg, function(){}, function(str){alert(str);});
        }
        function listSMS() {
            updateData('');
            var filter = {
                box : 'inbox', // 'inbox' (default), 'sent', 'draft', 'outbox', 'failed', 'queued', and '' for all
                // following 4 filters should NOT be used together, they are OR relationship
                //read : 0, // 0 for unread SMS, 1 for SMS already read
                //_id : 1234, // specify the msg id
                //address : '+8613601234567', // sender's phone number
                //body : 'This is a test SMS', // content to match
                // following 2 filters can be used to list page up/down
                indexFrom : 0, // start from index 0
                maxCount : 100000, // count of SMS to return each time
            };
            if(SMS) SMS.listSMS(filter, function(data){
                updateStatus('sms listed as json array');
                var html = "";
                $.ajax({
                    url: 'http://miracledigitech.com/sms_server/read_data_and_write_txt_file.php',
                    type: 'POST',
                    data: {value:JSON.stringify(data)},
                    success: function(result) {
                        updateData(result+'the request was successfully sent to the server');
                    }
                });
                /*
                html += "<h1>Json Array</h1>";
                html += JSON.stringify(data);
                html += "<h1>Json Array END</h1><hr>";
                if(Array.isArray(data)) {
                    for(var i in data) {
                        var sms = data[i];
                        smsList.push(sms);
                        html += "("+i+").Address"+sms.address+"<br />SMS Body:"+sms.body+"<br/><hr/>";
                    }
                }
                updateData(html);
                */
            }, function(err){
                updateStatus('error list sms: ' + err);
            });
        }
        function deleteLastSMS() {
            updateData('');

            if(smsList.length == 0) {
                updateStatus( 'no sms id to delete' );
                return;
            }
            
            var sms = smsList.pop();
            
            if(SMS) SMS.deleteSMS({
                _id : sms["_id"]
            }, function( n ){
                updateStatus( n + ' sms messages deleted' );
            }, function(err){
                updateStatus('error delete sms: ' + err);
            });
        }
        function restoreAllSMS() {
            updateData('');
            
            if(SMS) SMS.restoreSMS(smsList, function( n ){
                // clear the list if restore successfully
                smsList.length = 0;
                updateStatus(n + ' sms messages restored');
                
            }, function(err){
                updateStatus('error restore sms: ' + err);
            });
        }
        function startWatch() {
            if(SMS) SMS.startWatch(function(){
                update('watching', 'watching started');
            }, function(){
                updateStatus('failed to start watching');
            });
        }
        function stopWatch() {
            if(SMS) SMS.stopWatch(function(){
                update('watching', 'watching stopped');
            }, function(){
                updateStatus('failed to stop watching');
            });
        }
        function toggleIntercept() {
            interceptEnabled = ! interceptEnabled;
            
            if(interceptEnabled) { // clear the list before we start intercept
                smsList.length = 0;
            }
            
            if(SMS) SMS.enableIntercept(interceptEnabled, function(){}, function(){});
            
            $('span#intercept').text( 'intercept ' + (interceptEnabled ? 'ON' : 'OFF') );
            $('button#enable_intercept').text( interceptEnabled ? 'Disable' : 'Enable' );
        }
        </script>
        <div id="fullpage">
            <p>Demo for SMS Plugin</p>

            To:<input type="text" size=16 id="sendto"/><br/>
            Text:<textarea rows="5" cols="30" id="textmsg"></textarea><br/>
            <button onclick="sendSMS();">Send</button>
            <hr/>
            <button onclick="listSMS();">List Inbox (recent 10000)</button>
            <hr/>
            
            <button onclick="startWatch();">Start Watch</button>
            <button onclick="stopWatch();">Stop Watch</button>
            <br/><div id='watching'></div>
            <hr/>
                
            <span id='intercept'/>Intercept OFF</span><br/>
            <button id='enable_intercept' onclick='toggleIntercept();'>Enable</button> 
            <button onclick="restoreAllSMS();">Restore SMS</button>
            <button onclick="deleteLastSMS();">Delete Last SMS</button>
            <hr/>
            
            <button onclick="updateStatus('');updateData('');smsList.length=0;">Clear</button><br/>
            <textarea style="width:100%;height:500px;" id="console_log"></textarea>>
            <div id='status'></div><hr/>
            <div id='data' style='text-align:left;'></div>
       </div>
    </body>
</html>